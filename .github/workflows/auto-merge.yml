name: Auto-merge dependency PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run on PRs from automation bots or PRs with automated/dependencies labels
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' ||
      github.event.pull_request.user.login == 'github-actions[bot]' ||
      github.event.pull_request.user.login == 'renovate[bot]' ||
      contains(github.event.pull_request.labels.*.name, 'automated') ||
      contains(github.event.pull_request.labels.*.name, 'dependencies')
    steps:
      - name: Wait for check-flake to complete
        run: |
          echo "Waiting for check-flake workflow to complete for PR #${{ github.event.pull_request.number }}..."
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "PR head SHA: $HEAD_SHA"
          
          # Wait up to 10 minutes for the check-flake workflow to complete
          MAX_ITERATIONS=60
          SLEEP_SECONDS=10
          
          for i in $(seq 1 $MAX_ITERATIONS); do
            # Get check runs for this SHA
            CHECK_RUNS=$(gh api "/repos/${{ github.repository }}/commits/$HEAD_SHA/check-runs" --jq '.check_runs')
            
            # Look for check-flake run
            CHECK_FLAKE=$(echo "$CHECK_RUNS" | jq '.[] | select(.name == "check-flake")')
            
            if [[ -z "$CHECK_FLAKE" ]]; then
              echo "No check-flake run found yet... waiting ($i/$MAX_ITERATIONS)"
              sleep $SLEEP_SECONDS
              continue
            fi
            
            STATUS=$(echo "$CHECK_FLAKE" | jq -r '.status')
            CONCLUSION=$(echo "$CHECK_FLAKE" | jq -r '.conclusion')
            
            echo "Check-flake status: $STATUS, conclusion: $CONCLUSION"
            
            if [[ "$STATUS" == "completed" ]]; then
              if [[ "$CONCLUSION" == "success" ]]; then
                echo "‚úÖ Check-flake workflow passed!"
                exit 0
              else
                echo "‚ùå Check-flake workflow failed with conclusion: $CONCLUSION"
                echo "Not auto-merging."
                exit 1
              fi
            fi
            
            echo "‚è≥ Check-flake workflow is still running... ($i/$MAX_ITERATIONS)"
            sleep $SLEEP_SECONDS
          done
          
          echo "‚è±Ô∏è Timeout waiting for check-flake workflow"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        run: |
          # Check if already approved by github-actions bot
          EXISTING_REVIEWS=$(gh pr view ${{ github.event.pull_request.number }} --json reviews --jq '.reviews[] | select(.author.login == "github-actions[bot]") | .state')
          
          if echo "$EXISTING_REVIEWS" | grep -q "APPROVED"; then
            echo "‚úÖ PR already approved by github-actions[bot]"
          else
            echo "‚úÖ Approving PR #${{ github.event.pull_request.number }}"
            gh pr review ${{ github.event.pull_request.number }} --approve --body "Auto-approving dependency update PR after check-flake passed ‚úÖ"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        run: |
          echo "üîÑ Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash || {
            echo "‚ÑπÔ∏è Auto-merge already enabled or cannot be enabled (this is okay)"
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
