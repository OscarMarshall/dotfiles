name: Auto-merge dependency PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run on PRs from automation bots or PRs with automated/dependencies labels
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' ||
      github.event.pull_request.user.login == 'github-actions[bot]' ||
      github.event.pull_request.user.login == 'renovate[bot]' ||
      contains(github.event.pull_request.labels.*.name, 'automated') ||
      contains(github.event.pull_request.labels.*.name, 'dependencies')
    steps:
      - name: Check PR author and labels
        id: check
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "PR author: $PR_AUTHOR"
          
          # Check if PR is from a bot or has automated/dependencies labels
          if [[ "$PR_AUTHOR" == "dependabot[bot]" ]] || [[ "$PR_AUTHOR" == "github-actions[bot]" ]] || [[ "$PR_AUTHOR" == "renovate[bot]" ]]; then
            echo "is_automated=true" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'automated') }}" == "true" ]] || [[ "${{ contains(github.event.pull_request.labels.*.name, 'dependencies') }}" == "true" ]]; then
            echo "is_automated=true" >> $GITHUB_OUTPUT
          else
            echo "is_automated=false" >> $GITHUB_OUTPUT
            echo "PR is not automated"
            exit 0
          fi

      - name: Wait for check-flake to complete
        if: steps.check.outputs.is_automated == 'true'
        run: |
          echo "Waiting for check-flake workflow to complete for PR #${{ github.event.pull_request.number }}..."
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "PR head SHA: $HEAD_SHA"
          
          # Wait up to 10 minutes for the check-flake workflow to complete
          for i in {1..60}; do
            # Get check runs for this SHA
            CHECK_RUNS=$(gh api "/repos/${{ github.repository }}/commits/$HEAD_SHA/check-runs" --jq '.check_runs')
            
            # Look for check-flake run
            CHECK_FLAKE=$(echo "$CHECK_RUNS" | jq '.[] | select(.name == "check-flake")')
            
            if [[ -z "$CHECK_FLAKE" ]]; then
              echo "No check-flake run found yet... waiting ($i/60)"
              sleep 10
              continue
            fi
            
            STATUS=$(echo "$CHECK_FLAKE" | jq -r '.status')
            CONCLUSION=$(echo "$CHECK_FLAKE" | jq -r '.conclusion')
            
            echo "Check-flake status: $STATUS, conclusion: $CONCLUSION"
            
            if [[ "$STATUS" == "completed" ]]; then
              if [[ "$CONCLUSION" == "success" ]]; then
                echo "‚úÖ Check-flake workflow passed!"
                exit 0
              else
                echo "‚ùå Check-flake workflow failed with conclusion: $CONCLUSION"
                echo "Not auto-merging."
                exit 1
              fi
            fi
            
            echo "‚è≥ Check-flake workflow is still running... ($i/60)"
            sleep 10
          done
          
          echo "‚è±Ô∏è Timeout waiting for check-flake workflow"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        if: steps.check.outputs.is_automated == 'true'
        run: |
          # Check if already approved by github-actions bot
          EXISTING_REVIEWS=$(gh pr view ${{ github.event.pull_request.number }} --json reviews --jq '.reviews[] | select(.author.login == "github-actions[bot]") | .state')
          
          if echo "$EXISTING_REVIEWS" | grep -q "APPROVED"; then
            echo "‚úÖ PR already approved by github-actions[bot]"
          else
            echo "‚úÖ Approving PR #${{ github.event.pull_request.number }}"
            gh pr review ${{ github.event.pull_request.number }} --approve --body "Auto-approving dependency update PR after check-flake passed ‚úÖ"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check.outputs.is_automated == 'true'
        run: |
          echo "üîÑ Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash || {
            echo "‚ÑπÔ∏è Auto-merge already enabled or cannot be enabled (this is okay)"
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
